<!doctype html>
<html lang="en" prefix="og: http://ogp.me/ns#">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testing STUN and TURN servers</title>
  <meta name="description"
    content="Testing STUN and TURN servers">
  
  <meta name="keywords" content="Cisco Expressway, STUN, TURN, CVE-2020-3482, CSCvt83751, testing, security, penetration test, red teaming, vulnerability">
  
  <meta name="author" content="Christian Mehlmauer">

  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@firefart" />
  <meta name="twitter:creator" content="@firefart" />
  
  <meta name="twitter:title" content="Testing STUN and TURN servers">
  <meta name="twitter:description"
    content="Testing STUN and TURN servers">
  <meta property="og:title" content="Testing STUN and TURN servers">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://firefart.at/post/testing_stun_and_turn_servers/" />
  <meta property="og:description"
    content="Testing STUN and TURN servers">
  
  <meta property="og:image" content="https://www.gravatar.com/avatar/530ee2111e51f3d8379b1081d13bf345.png?s=400" />
  <meta name="twitter:image" content="https://www.gravatar.com/avatar/530ee2111e51f3d8379b1081d13bf345.png?s=400" />
  
  <meta property="og:updated_time" content="2021-08-15 22:00:00 &#43;0100 &#43;0100" />
  <meta property="article:author" content="https://twitter.com/firefart" />

  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700%7COxygen:400,700" rel="stylesheet"
    type="text/css">
  <link rel="stylesheet" href="https://yui-s.yahooapis.com/pure/0.6.0/pure-min.css">
  <link rel="stylesheet" href="https://yui-s.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href='https://firefart.at/css/all.css'>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

  
  
  <script type="application/ld+json">
    [{
        "@context": "http://schema.org",
        "@type": "WebSite",
        "name": "FireFart",
        "url": "https://firefart.at"
      },
      {
        "@context": "http://schema.org",
        "@type": "Person",
        "name": "Christian Mehlmauer",
        "url": "https://firefart.at",
        "sameAs": [
          "https://twitter.com/firefart",
          "https://github.com/FireFart",
          "https://www.facebook.com/christian.mehlmauer"
        ]
      }
    ]
  </script>

</head>

<body>

<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <h1 class="brand-title"><a href="/">FireFart</a></h1>
        <h2 class="brand-tagline"> that austrian security guy </h2>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" target="_blank" href="https://twitter.com/firefart">
                        <i class="fa fa-twitter"></i> Twitter
                    </a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" target="_blank" href="https://github.com/FireFart">
                        <i class="fa fa-github-alt"></i> Github
                    </a>
                </li>
                
                
                
                <li class="nav-item">
                    <a class="pure-button" href="/page/about/"><i class="fa fa-info"></i> about me</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" target="_blank" href='https://firefart.at/index.xml'>
                        <i class="fa fa-rss"></i> rss
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                <h1 class="content-subhead">15 Aug 2021, 22:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="/post/testing_stun_and_turn_servers/" class="post-title">Testing STUN and TURN servers</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div id="toc" class="well col-md-4 col-sm-6">
                        <nav id="TableOfContents"></nav>
                    </div>

                    <div class="post-description">
                        <p>Some time ago I came across a <a href="https://hackerone.com/reports/333419">HackerOne report</a> about abusing Slacks TURN server for proxy functionality inside their internal network. There are currently no public tools available to test for this kind of vulnerability so I decided to take a look at this topic and develop a free tool to help in testing.</p>
<p>To test all this I decided to take a look at our Videoconferencing software at work which happens to be Cisco Expressway. During testing I also found a few vulnerabilities which will also be shortly covered in this blog post. Cisco first released the vulnerabilities as <code>medium</code> serverity and later changed the article to a RTFM one. TL;DR;: These bugs are not and will not be fixed by cisco. The easiest would be a configurable target whitelist but according to XXXX they can not implement it because of their product architecture. So if you happen to have a Cisco Expressway with open STUN/TURN ports be sure to have strong admin passwords on your admin interfaces and segregate the devices as much as possible from the rest of the network as you are able to access each IP on each port via the Expressway.</p>
<p><a href="https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-Expressway-8J3yZ7hV.html">https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-Expressway-8J3yZ7hV.html</a></p>
<p>Here is a small demonstration video accessing the admin interface of another expressway server which is not publicily available on the internet.</p>
<p>So what are STUN and TURN? Both are protocols mostly used in Audio and Video conferencing solutions.</p>
<p>I think both topics are well documented on Wikipedia and the referenced blog posts, so this will only be a short blog post what&rsquo;s possible. For info about how to use the new tool please refer to the <a href="https://github.com/FireFart/stunner/blob/master/Readme.md">Readme</a> on Github.</p>
<h1 id="stun">STUN</h1>
<p>STUN is defined in <a href="https://tools.ietf.org/html/rfc5389">RFC 5389 - Session Traversal Utilities for NAT (STUN)</a> and is a protocol for devices behind NATs to discover if they are using another IP (NAT) when communicating with a target. This result is then used by other protocols to find the best path to communicate with each other. This protocol is heavily used in voice and video installations. There are several other protocols that make use of STUN.</p>
<p>For more information on the STUN protocol have a look at <a href="https://en.wikipedia.org/wiki/STUN">Wikipedia</a> or the <a href="https://tools.ietf.org/html/rfc5389">RFC</a> itself.</p>
<h1 id="turn">TURN</h1>
<p>TURN is extension to the above mentioned STUN protocol. It just defines new Attributes and Methods on top of the already established protocol. TURN is used as kind of a proxy server to single peers where one or more endpoint is behind a NAT. The client can contact the TURN server, requests that all packets are forwarded to a target, and if the server is configured correctly, it should only allow forwards to known and trusted IP adresses. After this the peers have a direct data connection over the NAT devices to communicate with each other. This feature is also used in many video and voice call systems to route the media traffic from a client to a backend server. Using this technique the client and the backend can both be behind different NATs and still communicate which each other.</p>
<p>The TURN extensions are defined in <a href="https://tools.ietf.org/html/rfc5766">RFC 5766 - Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a> and <a href="https://tools.ietf.org/html/rfc6062">RFC 6062 - Traversal Using Relays around NAT (TURN) Extensions for TCP Allocations</a> defines TURN over TCP connections. <a href="https://en.wikipedia.org/wiki/Traversal_Using_Relays_around_NAT">Wikipedia</a> also has some more information on the protocol and the basic behaviour.</p>
<h1 id="testing">TESTING</h1>
<p>As you might have seen misconfigured servers can act as an open relay into the internal network or other internet facing servers. All the attacker needs are some valid credentials which are exchanged via out of bounds methods like over http. These can be captured for example by using a webclient for a meeting solution and grab the credentials using an intercepting proxy like in <a href="https://hackerone.com/reports/333419">https://hackerone.com/reports/333419</a>. These credentials are most often short lived so be sure to grab new credentials when you recieve authentication errors during testing.</p>
<p>There are also two nice blogposts which desribe this feature and how to abuse it:</p>
<p><a href="https://www.rtcsec.com/2020/04/01-slack-webrtc-turn-compromise/">How we abused Slack&rsquo;s TURN servers to gain access to internal services</a> and the corresponding <a href="https://hackerone.com/reports/333419">HackerOne report</a>.</p>
<p><a href="https://www.immunit.ch/en/blog/2018/06/12/vulnerability-disclosure-cisco-meeting-server-arbitrary-tcp-relaying-2/">Vulnerability disclosure â€“ Cisco Meeting Server (CMS) arbitrary TCP relaying</a></p>
<p>To test these servers I developed and released a new tool: <a href="https://github.com/FireFart/stunner">Stunner</a></p>
<p>The most usefull option in this tool is a local SOCKS5 server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./stunner socks -s x.x.x.x:3478 -u username -p password
</code></pre></div><p>This spins up a local socks5 proxy and relays all requests over the TURN TCP protocol to the target. If you configure your browser to use the local socks5 proxy you can test if you can access private ip ranges or localhost on the target. In my tests I was able to access some admin interfaces on localhost and also some internal systems. The socks proxy is currently only implemented for TCP connections, so the target must support TURN over TCP.</p>
<p>You can also use <code>proxychains</code> to do a TCP scan via nmap on various targets via this server, but it will be slow.</p>
<p>The <code>scanner</code> module tries to allocate some ressources on private or restricted ranges and gives you some hints where to look at and what limitations are implemented in this current product.</p>
<p>The tool has several other commands too, just refer to the <a href="https://github.com/FireFart/stunner/blob/master/Readme.md">Readme</a>.</p>
                    </div>
                </section>
            </div>
            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Copyright by Christian Mehlmauer</li>
            <li>source code available on <a href="https://github.com/FireFart/firefart.github.io">Github</a></li>
        </ul>
    </div>
</div>
<script type="text/javascript" src='https://firefart.at/js/all.js'></script>
<script type="text/javascript" src='https://firefart.at/js/firefart.js'></script>

<script type="text/javascript">
    var _paq = window._paq || [];
     
    _paq.push(["setCookieDomain", "*.firefart.at"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function () {
        var u = "https://tracking.firefart.at/";
        _paq.push(['setTrackerUrl', u + 'mat.php']);
        _paq.push(['setSiteId', '1']);
        var d = document,
            g = d.createElement('script'),
            s = d.getElementsByTagName('script')[0];
        g.type = 'text/javascript';
        g.async = true;
        g.defer = true;
        g.src = u + 'mat.js';
        s.parentNode.insertBefore(g, s);
    })();
</script>
<noscript>
    <p><img src="https://tracking.firefart.at/mat.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p>
</noscript>

        </div>
    </div>
</div>
</body>

</html>